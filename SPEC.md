# ТЗ на доработку сервиса продажи сертификатов

## 1. Цель доработки

Создать полноценный рабочий сервис продажи сертификатов, который:

- хранит данные в PostgreSQL
- работает через GitHub + Vercel
- имеет 2 основные страницы
- адаптивен под мобильный
- доступен из Telegram Mini App и веб
- не требует отдельного сервера (serverless)

## 2. Архитектура

- **Frontend:** React, Next.js App Router (предпочтительно), размещение на Vercel.
- **Backend:** Vercel Serverless (API Routes в Next.js).
- **БД:** PostgreSQL (удалённая). Подключение **только** из serverless, не из браузера.
- **Credentials:** только в Vercel Environment Variables.

## 3. Ключевое ограничение

Не подключаться к PostgreSQL из браузера. Только через serverless-функции.

## 4. Структура проекта

```
/app
  page.tsx          — покупка
  vault/page.tsx    — мои сертификаты
/app/api
  create-certificate
  identify-client
  get-vault
  cities
  tariffs
  designs
  redeem-certificate  — погашение при записи
/lib
  db.ts
  certificate.ts
  code.ts
```

## 5. Функционал страниц

### Страница 1 — Покупка

- Выбор города, тарифа, дизайна.
- Имя получателя, поздравление.
- Кнопка «Оплатить» (MVP: создание сертификата без реальной оплаты; позже — YooKassa).
- API: `GET /api/cities`, `GET /api/tariffs?city=...`, `GET /api/designs?city=...`, `POST /api/create-certificate`.

### Страница 2 — Vault (мои сертификаты)

- По `telegram_id` (Mini App) или email/номер (веб).
- `GET /api/get-vault?telegram_id=...`
- Показать: код, город, тариф, дата окончания, статус.

## 6. Бизнес-логика

### Создание сертификата

- Проверить/создать клиента по `telegram_id`.
- Проверить тариф, дизайн, город.
- Сгенерировать уникальный код формата `QPIC-XXXX-YYYY` (4 буквы + 4 цифры), retry при коллизии.
- `expires_at = now + 6 months`.
- Сохранить в БД.
- **Оповещение о продаже в Telegram-чат админу** (кто купил, код; позже — чек при интеграции YooKassa).

### Погашение сертификата

- Когда клиент записывается и «оплачивает» сертификатом — сертификат гасится в БД (статус `redeemed`/`used`).
- API: `POST /api/redeem-certificate` (код в теле или query).

### Истечение срока

- Если сертификат не использован в течение 6 месяцев с момента продажи — считается истёкшим (уже заложено в `expires_at`; при выдаче/записи проверять срок и статус).

## 7. API

| Метод | Путь | Назначение |
|-------|------|------------|
| POST | /api/create-certificate | Создание сертификата, уведомление админу |
| GET  | /api/get-vault | Сертификаты клиента по telegram_id |
| POST | /api/identify-client | Проверка/создание клиента по telegram_id |
| GET  | /api/cities | Список городов |
| GET  | /api/tariffs | Тарифы (опционально ?city=) |
| GET  | /api/designs | Дизайны (опционально ?city=) |
| POST | /api/redeem-certificate | Погашение по коду |

## 8. Безопасность

- Только parameterized queries (pg), без интерполяции SQL.
- Валидация входных данных в API.
- Секреты только в `process.env` (Vercel).

## 9. UI

- Mobile-first, кнопки не менее 44px.
- Без горизонтального скролла, адаптив 320–1440px.
- Минималистичный дизайн, светлая тема.

## 10. Что не входит в текущий MVP

- Генерация PDF.
- Интеграция YooKassa (будет позже).
- Админка, управление городами.

## 11. MVP Definition of Done

- Сертификат создаётся и сохраняется в БД.
- Отображается в Vault.
- Работает на телефоне и в вебе.
- Нет прямого доступа к БД из браузера.
- Оповещение админу в Telegram при продаже.
- Возможность погасить сертификат по коду (для записи в студию).

## 12. Переменные окружения

- `POSTGRES_URL` — подключение к PostgreSQL.
- `TELEGRAM_BOT_TOKEN` (опционально) — для отправки уведомлений админу.
- `TELEGRAM_ADMIN_CHAT_ID` (опционально) — ID чата для уведомлений о продаже.
